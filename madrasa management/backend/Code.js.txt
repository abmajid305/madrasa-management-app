


const SPREADSHEET_ID = '1VmeBxYxuiezrRvJpyIEWfmSLonzv7zFqD-XMLKAMG-s';

function doGet() {
  return HtmlService.createTemplateFromFile('index')
    .evaluate()
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function authenticateStudent(username, password, className) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(className);
    
    if (!sheet) {
      return { success: false, message: 'Class not found' };
    }
    
    const data = sheet.getDataRange().getValues();
    
    // Convert username and password to string for comparison
    const usernameStr = String(username).trim();
    const passwordStr = String(password).trim();
    
    // Debug: Log the data structure
    console.log('Sheet data rows:', data.length);
    console.log('Looking for username:', usernameStr, 'password:', passwordStr);
    
    // FIXED: Changed loop to start from row 4 (index 3) instead of row 4 (index 3)
    // This ensures we check all student rows properly
    for (var i = 4; i < data.length; i++) {
      // FIXED: Added better null/undefined checking
      var rowUsername = '';
      var rowPassword = '';
      
      // Safely extract username and password
      if (data[i] && data[i].length > 0 && data[i][0] !== null && data[i][0] !== undefined) {
        rowUsername = String(data[i][0]).trim();
      }
      
      if (data[i] && data[i].length > 1 && data[i][1] !== null && data[i][1] !== undefined) {
        rowPassword = String(data[i][1]).trim();
      }
      
      console.log(`Row ${i + 1}: username='${rowUsername}', password='${rowPassword}'`);
      
      // FIXED: Skip empty rows
      if (!rowUsername && !rowPassword) {
        continue;
      }
      
      if (rowUsername === usernameStr && rowPassword === passwordStr) {
        // Helper function to safely get cell value
        var getCellValue = (row, col, defaultValue = '') => {
          try {
            if (!data[row] || data[row].length <= col || data[row][col] === null || data[row][col] === undefined) {
              return defaultValue;
            }
            return String(data[row][col]).trim();
          } catch (e) {
            console.error(`Error getting cell value at row ${row}, col ${col}:`, e);
            return defaultValue;
          }
        };
        
        // Helper function to safely get numeric value
        var getNumericValue = (row, col, defaultValue = 0) => {
          try {
            if (!data[row] || data[row].length <= col || data[row][col] === null || data[row][col] === undefined) {
              return defaultValue;
            }
            var value = data[row][col];
            var numValue = parseFloat(value);
            return isNaN(numValue) ? defaultValue : numValue;
          } catch (e) {
            console.error(`Error getting numeric value at row ${row}, col ${col}:`, e);
            return defaultValue;
          }
        };
        
        // FIXED: Better error handling and data extraction
        const studentData = {
          username: rowUsername,
          name: getCellValue(i, 2, 'No Name'),
          father: getCellValue(i, 3, 'No Father Name'),
          mother: getCellValue(i, 4, 'No Mother Name'),
          dob: getCellValue(i, 5, 'No DOB'),
          todayAttendance: getNumericValue(i, 6, null),
          totalWorkingDays: getNumericValue(3, 7, 100), // G3
          presentDays: getNumericValue(i, 7, 0), // Present days for this student
          totalLeave: getNumericValue(i, 8, 0),
          leaveDate:getCellValue(i, 9, 0),

          monthsPaid: getNumericValue(i, 10, 0),
          totalPaid: getNumericValue(i, 11, 0),
          monthlyRate: getNumericValue(3, 11, 90),
          balance: getNumericValue(i, 12, 0),
          lastpaymentdate: getCellValue(i, 13, 'No Date'),
          examfeepaid: getNumericValue(i, 14, 0),
          otherpayment: getNumericValue(i, 15, 0),

          totalParentmeet: getNumericValue(3, 18, 0),
          parentMeetparticipation: getNumericValue(i, 18, 0),
          parentMeetnonparticipation: getNumericValue(i, 19, 0),
          participant: getCellValue(i,20,'no name available'),
          remark:getCellValue(i,21,'no remark'),
          importantNotice:getCellValue(i,70,'no important notice'),


          qquranMax: getNumericValue(3, 22, 0), 
          qquranScored: getNumericValue(i, 22, 0),
          qhifzMax: getNumericValue(3, 23, 50), 
          qhifzScored: getNumericValue(i, 23, 0), 
          qfiqhMax: getNumericValue(3, 24, 50), // 
          qfiqhScored: getNumericValue(i, 24, 0), // Student's FIQH score 
          qaqeedaMax: getNumericValue(3, 25, 50), 
          qaqeedaScored: getNumericValue(i, 25, 0),
          qthareeqMax: getNumericValue(3, 26, 50), // 
          qthareeqScored: getNumericValue(i, 26, 0), // Student's THAREEQ score
          qthajveedMax: getNumericValue(3, 27, 50), 
          qthajveedScored: getNumericValue(i, 27, 0),
          qlisanMax: getNumericValue(3, 28, 50), // 
          qlisanScored: getNumericValue(i, 28, 0), // Student's LISAN score
          qaklaqMax: getNumericValue(3, 29, 50), 
          qaklaqScored: getNumericValue(i, 29, 0),
          qduroosMax: getNumericValue(3, 30, 50), // 
          qduroosScored: getNumericValue(i, 30, 0), // Student's DUROOS score
          qthafseerMax: getNumericValue(3, 31, 50), 
          qthafseerScored: getNumericValue(i, 31, 0),
          qkithabaMax: getNumericValue(3, 32, 50), 
          qkithabaScored: getNumericValue(i, 32, 0),
          qkirathMax: getNumericValue(3, 33, 50), 
          qkirathScored: getNumericValue(i, 33, 0),
          qpracticalMax: getNumericValue(3, 34, 50), 
          qpracticalScored: getNumericValue(i, 34, 0),
          qtotal: getNumericValue(i, 35, 0), // Total marks
          qclassIndex: getNumericValue(i, 36, 0), // Class position
          qstatus: getCellValue(i, 37, 'Not published'),
        
          hquranMax: getNumericValue(3, 38, 50), 
          hquranScored: getNumericValue(i, 38, 0),
          hhifzMax: getNumericValue(3, 39, 50), 
          hhifzScored: getNumericValue(i, 39, 0),
          hfiqhMax: getNumericValue(3, 40, 50), // 
          hfiqhScored: getNumericValue(i, 40, 0), // Student's FIQH score
          haqeedaMax: getNumericValue(3, 41, 50), 
          haqeedaScored: getNumericValue(i, 41, 0),
          hthareeqMax: getNumericValue(3, 42, 50), // 
          hthareeqScored: getNumericValue(i, 42, 0), // Student's THAREEQ score
          hthajveedMax: getNumericValue(3, 43, 50), 
          hthajveedScored: getNumericValue(i, 43, 0),
          hlisanMax: getNumericValue(3, 44, 50), // 
          hlisanScored: getNumericValue(i, 44, 0), // Student's LISAN score
          haklaqMax: getNumericValue(3, 45, 50), 
          haklaqScored: getNumericValue(i, 45, 0),
          hduroosMax: getNumericValue(3, 46, 50), // 
          hduroosScored: getNumericValue(i, 46, 0), // Student's DUROOS score
          hthafseerMax: getNumericValue(3, 47, 50), 
          hthafseerScored: getNumericValue(i, 47, 0),
          hkithabaMax: getNumericValue(3, 48, 50), 
          hkithabaScored: getNumericValue(i, 48, 0),
          hkirathMax: getNumericValue(3, 49, 50),
          hkirathScored: getNumericValue(i, 49, 0),
          hpracticalMax: getNumericValue(3, 50, 50), 
          hpracticalScored: getNumericValue(i, 50, 0),
          htotal: getNumericValue(i, 51, 0), // Total marks
          hclassIndex: getNumericValue(i, 52, 0), // Class position
          hstatus: getCellValue(i, 53, 'Not published'),
          fquranMax: getNumericValue(3, 54, 50), 
          fquranScored: getNumericValue(i, 54, 0),
          fhifzMax: getNumericValue(3, 55, 50), 
          fhifzScored: getNumericValue(i, 55, 0),  
          ffiqhMax: getNumericValue(3, 56, 50), // 
          ffiqhScored: getNumericValue(i, 56, 0), // Student's FIQH score
          faqeedaMax: getNumericValue(3, 57, 50), 
          faqeedaScored: getNumericValue(i, 57, 0),
          fthareeqMax: getNumericValue(3, 58, 50), // 
          fthareeqScored: getNumericValue(i, 58, 0), // Student's THAREEQ score
          fthajveedMax: getNumericValue(3, 59, 50), 
          fthajveedScored: getNumericValue(i, 59, 0),
          flisanMax: getNumericValue(3, 60, 50), // 
          flisanScored: getNumericValue(i, 60, 0), // Student's LISAN score
          faklaqMax: getNumericValue(3, 61, 50), 
          faklaqScored: getNumericValue(i, 61, 0),
          fduroosMax: getNumericValue(3, 62, 50), // 
          fduroosScored: getNumericValue(i, 62, 0), // Student's DUROOS score
          fthafseerMax: getNumericValue(3, 63, 50), 
          fthafseerScored: getNumericValue(i, 63, 0),
          fkithabaMax: getNumericValue(3, 64, 50), 
          fkithabaScored: getNumericValue(i, 64, 0),
          fkirathMax: getNumericValue(3, 65, 50), 
          fkirathScored: getNumericValue(i, 65, 0),

          fpracticalMax: getNumericValue(3, 66, 50), 
          fpracticalScored: getNumericValue(i, 66, 0),
          ftotal: getNumericValue(i, 67, 0), // Total marks
          fclassIndex: getNumericValue(i, 68, 0), // Class position
          fstatus: getCellValue(i, 69, 'Not published'),
          alloverGrandTotal: getNumericValue(i, 70, 0),      // Combined total of all exams
          alloverGrandRank: getNumericValue(i, 71, 0),       // Overall class rank (marks)
          alloverAttendanceRank: getNumericValue(i, 72, 0),  // Rank in attendance

          className: className
          




        };
        
        console.log('Student data found:', studentData);
        
        return {
          success: true,
          student: studentData
        };
      }
    }
    
    console.log('No matching student found');
    return { success: false, message: 'Invalid username or password' };
  } catch (error) {
    console.error('Authentication error:', error);
    return { success: false, message: 'Error accessing data: ' + error.toString() };
  }
}

function getClassList() {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheets = ss.getSheets();
    return sheets.map(sheet => sheet.getName()).filter(name => name.toLowerCase().includes('class'));
  } catch (error) {
    console.error('Error getting class list:', error);
    return ['class1']; // Default fallback
  }
}

function getAllStudentsForRanking(className) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(className);
    if (!sheet) return [];

    const data = sheet.getDataRange().getValues();
    const students = [];

    // Start from row 5 (index 4) â†’ skip headers (since data starts from row 5)
    for (let i = 4; i < data.length; i++) {
      const row = data[i];
      if (!row || row.length === 0 || row[0] === "" || row[0] == null) continue;

      const username = String(row[0]).trim();
      if (!username) continue;

      const name = row[2] ? String(row[2]).trim() : "No Name";
      const alloverGrandRank = parseFloat(row[71]); //

      // Only include students who have valid rank values
      if (!isNaN(alloverGrandRank) && alloverGrandRank > 0) {
        students.push({
          name,
          username,
          alloverGrandRank
        });
      }
    }

    // Sort by rank ascending (1 = best)
    return students.sort((a, b) => a.alloverGrandRank - b.alloverGrandRank);

  } catch (error) {
    console.error("Ranking error:", error);
    return [];
  }
}


// ADDED: Debug function to help troubleshoot data structure
function debugSheetData(className) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(className);
    
    if (!sheet) {
      return 'Sheet not found';
    }
    
    const data = sheet.getDataRange().getValues();
    
    console.log('=== DEBUG SHEET DATA ===');
    console.log('Total rows:', data.length);
    
    for (let i = 0; i < Math.min(10, data.length); i++) {
      console.log(`Row ${i + 1}:`, data[i]);
    }
    
    return 'Debug info logged to console';
  } catch (error) {
    console.error('Debug error:', error);
    return 'Error: ' + error.toString();
  }
}


